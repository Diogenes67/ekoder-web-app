<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EKoder-4o – ED Principal Diagnosis Coder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            padding: 1.5rem 0;
        }

        .header h1 {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .disclaimer {
            background-color: #fff3cd;
            padding: 12px 16px;
            border-radius: 6px;
            border: 1px solid #ffe69c;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #856404;
        }

        /* Settings Panel */
        .settings-panel {
            background: #f9fafb;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .settings-panel h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .settings-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            align-items: center;
        }

        .setting-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .setting-group label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .slider {
            width: 120px;
            height: 6px;
            -webkit-appearance: none;
            background: #e5e7eb;
            border-radius: 3px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
            background: var(--card-bg);
            padding: 0 1rem;
            border-radius: 8px 8px 0 0;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab:hover {
            color: var(--primary-color);
            background: #f9fafb;
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 1.25rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .button-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        button {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background-color: #e5e7eb;
            color: var(--text-primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #d1d5db;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        /* Results Section */
        .results-section {
            margin-top: 2rem;
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .results-header h2 {
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        .result-item {
            background: #f9fafb;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
            cursor: pointer;
        }

        .result-item:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .result-code {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .result-term {
            font-weight: 600;
            color: var(--text-primary);
            margin-left: 0.5rem;
        }

        .result-scale {
            color: var(--warning-color);
            font-weight: bold;
            font-size: 1.1rem;
        }

        .result-keywords {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-style: italic;
            margin-bottom: 0.5rem;
        }

        .result-explanation {
            color: var(--text-primary);
            line-height: 1.5;
        }

        /* Shortlist Section */
        .shortlist-section {
            margin-top: 2rem;
        }

        .shortlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 0.5rem 2.5rem 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .search-box svg {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .shortlist-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f3f4f6;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        tr:hover {
            background: #f9fafb;
        }

        .score-cell {
            font-family: monospace;
            color: var(--text-secondary);
        }

        /* File Upload */
        .file-upload {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: var(--primary-color);
            background: #f0f9ff;
        }

        .file-upload.dragover {
            border-color: var(--primary-color);
            background: #dbeafe;
            transform: scale(1.02);
        }

        .file-upload h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .file-upload p {
            color: var(--text-secondary);
        }

        .file-list {
            margin-top: 1.5rem;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-color);
        }

        .file-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        /* Loading and Progress */
        .loading {
            text-align: center;
            padding: 3rem;
        }

        .spinner {
            display: inline-block;
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s;
        }

        /* Messages */
        .message {
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .message.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .message.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fbbf24;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        /* Debug Section */
        .debug-section {
            background: #f3f4f6;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
        }

        .debug-section h4 {
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .debug-info {
            background: white;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--primary-color);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            display: none;
            align-items: center;
            gap: 0.5rem;
            z-index: 1000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .settings-row {
                flex-direction: column;
                align-items: stretch;
            }

            .setting-group {
                width: 100%;
            }

            .tabs {
                overflow-x: auto;
                padding: 0;
            }

            .tab {
                font-size: 0.9rem;
                padding: 0.5rem 1rem;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                width: 100%;
                justify-content: center;
            }

            .search-box {
                width: 100%;
            }

            .shortlist-container {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1>🏥 EKoder-4o – ED Principal Diagnosis Coder</h1>
                <div class="disclaimer">
                    <strong>Disclaimer:</strong> <em>EKoder-4o</em> is a research and educational tool. 
                    It does <u>not</u> provide medical advice, and outputs must be reviewed by
                    qualified clinical staff. Use only with fully de-identified notes and in
                    compliance with your organisation's privacy and governance policies.
                </div>
            </div>
        </div>
    </header>

    <main class="container" style="padding-top: 1rem; padding-bottom: 3rem;">
        <!-- Settings Panel -->
        <div class="settings-panel">
            <h3>⚙️ Settings</h3>
            <div class="settings-row">
                <div class="setting-group">
                    <label for="gptModel">GPT Model:</label>
                    <select id="gptModel">
                        <option value="gpt-4o" selected>gpt-4o</option>
                        <option value="gpt-4-turbo-preview">gpt-4-turbo-preview</option>
                        <option value="gpt-4">gpt-4</option>
                    </select>
                </div>
                
                <div class="setting-group">
                    <label for="temperature">Temperature:</label>
                    <div class="slider-container">
                        <input type="range" id="temperature" class="slider" min="0" max="10" value="0">
                        <span id="tempValue">0.0</span>
                    </div>
                </div>

                <div class="setting-group">
                    <button class="btn-secondary" onclick="rebuildTFIDF()">
                        🔄 Re-build TF-IDF
                    </button>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="debugMode" checked>
                    <label for="debugMode">🪛 Verbose debug</label>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('paste')">
                📝 Paste Note
            </button>
            <button class="tab" onclick="switchTab('upload')">
                📁 Upload File
            </button>
            <button class="tab" onclick="switchTab('batch')">
                📚 Batch Process
            </button>
        </div>

        <!-- Tab Contents -->
        <div id="pasteTab" class="tab-content active">
            <div class="card">
                <div class="form-group">
                    <label for="noteInput">Paste or enter de-identified casenote here:</label>
                    <textarea id="noteInput" rows="12" placeholder="Enter the emergency department clinical note here..."></textarea>
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="processNote()">
                        🚀 Process Note
                    </button>
                    <button class="btn-secondary" onclick="clearNote()">
                        🗑️ Clear
                    </button>
                </div>
            </div>
        </div>

        <div id="uploadTab" class="tab-content">
            <div class="card">
                <div class="file-upload" onclick="document.getElementById('fileInput').click()" 
                     ondrop="handleDrop(event)" ondragover="handleDragOver(event)" 
                     ondragleave="handleDragLeave(event)">
                    <input type="file" id="fileInput" accept=".txt" style="display: none;" 
                           onchange="handleFileSelect(event)">
                    <h3>Choose a .txt file</h3>
                    <p>Click to browse or drag and drop</p>
                </div>
                <div id="uploadedFile" style="display: none; margin-top: 1.5rem;">
                    <div class="message success">
                        ✅ Loaded: <span id="uploadedFileName"></span>
                    </div>
                    <details open>
                        <summary style="font-weight: 600; margin-bottom: 0.5rem; cursor: pointer;">
                            📄 File Preview
                        </summary>
                        <textarea id="filePreview" rows="8" readonly style="background: #f9fafb; margin-top: 0.5rem;"></textarea>
                    </details>
                    <div class="button-group" style="margin-top: 1rem;">
                        <button class="btn-primary" onclick="processUploadedFile()">
                            🚀 Process This File
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="batchTab" class="tab-content">
            <div class="card">
                <h3 style="margin-bottom: 1rem;">📁 Batch Processing</h3>
                <div class="file-upload" onclick="document.getElementById('batchInput').click()"
                     ondrop="handleBatchDrop(event)" ondragover="handleDragOver(event)" 
                     ondragleave="handleDragLeave(event)">
                    <input type="file" id="batchInput" accept=".txt" multiple style="display: none;" 
                           onchange="handleBatchSelect(event)">
                    <h3>Select de-identified .txt files</h3>
                    <p>Select multiple files for batch processing</p>
                </div>
                <div id="batchFiles" class="file-list" style="display: none;">
                    <div class="message info" style="margin-top: 1rem;">
                        <span id="batchFileCount">0</span> file(s) ready
                    </div>
                    <div id="batchFileList"></div>
                    <button class="btn-primary" onclick="processBatch()" style="margin-top: 1rem;">
                        🚀 Run Batch
                    </button>
                </div>
                <div id="batchProgress" style="display: none; margin-top: 1.5rem;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Classifying...</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <p>Processing file <span id="currentFile">0</span> of <span id="totalFiles">0</span></p>
                    </div>
                </div>
                <div id="batchResults" style="display: none; margin-top: 1.5rem;">
                    <h4>Results</h4>
                    <div id="batchResultsTable" style="overflow-x: auto; margin-top: 1rem;"></div>
                    <button class="btn-primary" id="downloadExcel" style="margin-top: 1rem; display: none;">
                        ⬇️ Download Results (.xlsx)
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="results-section">
            <div class="card">
                <div class="results-header">
                    <h2>🏥 EKoder-4o Recommendations</h2>
                </div>
                <div id="resultsContent"></div>
            </div>

            <!-- Raw GPT Response (Debug) -->
            <div id="gptRawSection" style="display: none;">
                <div class="card">
                    <h3>GPT-4 Raw Output</h3>
                    <pre id="gptRawContent" style="background: #f9fafb; padding: 1rem; border-radius: 4px; overflow-x: auto;"></pre>
                </div>
            </div>

            <!-- Shortlist Section -->
            <div class="card shortlist-section">
                <div class="shortlist-header">
                    <h3>📊 Top 100 Codes by TF-IDF Similarity</h3>
                    <div class="search-box">
                        <input type="text" id="codeSearch" placeholder="🔍 Search codes...">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </div>
                </div>
                <p style="font-style: italic; color: var(--text-secondary); margin-bottom: 1rem;">
                    *These are the codes sent to GPT-4 for consideration:
                </p>
                <details open>
                    <summary style="font-weight: 600; margin-bottom: 1rem; cursor: pointer;">
                        View all 100 codes
                    </summary>
                    <div class="shortlist-container">
                        <table id="shortlistTable">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>ED Short List code</th>
                                    <th>ED Short List Term</th>
                                    <th>Score</th>
                                </tr>
                            </thead>
                            <tbody id="shortlistBody">
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </details>
            </div>

            <!-- Debug Section -->
            <div id="debugSection" class="debug-section" style="display: none;">
                <h4>🔍 Debug Information</h4>
                <div class="debug-info">
                    <strong>Key Symptoms Extracted:</strong>
                    <div id="debugKeySymptoms"></div>
                </div>
                <div class="debug-info">
                    <strong>TF-IDF Stats:</strong>
                    <div id="debugTfidf"></div>
                </div>
                <div class="debug-info">
                    <strong>Top 10 TF-IDF matches:</strong>
                    <div id="debugTopMatches"></div>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="toast">
            <span id="toastMessage">Code copied to clipboard!</span>
        </div>
    </main>

    <script>
        // Configuration
        const API_URL = 'http://localhost:8000/api';

        // State management
        let currentResults = null;
        let uploadedFileContent = null;
        let batchFiles = [];
        let shortlistData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Temperature slider
            const tempSlider = document.getElementById('temperature');
            const tempValue = document.getElementById('tempValue');
            tempSlider.addEventListener('input', (e) => {
                tempValue.textContent = (e.target.value / 10).toFixed(1);
            });

            // Code search
            const codeSearch = document.getElementById('codeSearch');
            codeSearch.addEventListener('input', filterShortlist);

            // Debug mode
            const debugMode = document.getElementById('debugMode');
            debugMode.addEventListener('change', toggleDebugMode);
        });

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Process note from paste tab
        async function processNote() {
            const noteText = document.getElementById('noteInput').value.trim();
            if (!noteText) {
                showToast('Please enter a clinical note', 'warning');
                return;
            }

            await processNoteText(noteText);
        }

        // Process uploaded file
        async function processUploadedFile() {
            if (!uploadedFileContent) {
                showToast('No file uploaded', 'warning');
                return;
            }

            await processNoteText(uploadedFileContent);
        }

        // Core processing function
        async function processNoteText(noteText) {
            // Show loading
            showLoading();

            try {
                const response = await fetch(API_URL + '/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        note_text: noteText,
                        model: document.getElementById('gptModel').value,
                        temperature: parseFloat(document.getElementById('tempValue').textContent),
                        debug_mode: document.getElementById('debugMode').checked
                    })
                });

                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }

                const data = await response.json();
                currentResults = data;
                displayResults(data);
                
            } catch (error) {
                console.error('Error:', error);
                showToast('Error processing note: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Display results
        function displayResults(data) {
            const resultsSection = document.getElementById('results');
            const resultsContent = document.getElementById('resultsContent');
            
            // Clear previous results
            resultsContent.innerHTML = '';

            // Display validated results
            if (data.validated_results && data.validated_results.length > 0) {
                data.validated_results.forEach((result, index) => {
                    const resultItem = createResultItem(result, index + 1);
                    resultsContent.appendChild(resultItem);
                });
            } else {
                resultsContent.innerHTML = '<div class="message warning">No valid codes parsed from GPT response.</div>';
            }

            // Show GPT raw output if debug mode or no results
            if (document.getElementById('debugMode').checked || !data.validated_results || data.validated_results.length === 0) {
                document.getElementById('gptRawSection').style.display = 'block';
                document.getElementById('gptRawContent').textContent = data.gpt_raw;
            } else {
                document.getElementById('gptRawSection').style.display = 'none';
            }

            // Display shortlist
            displayShortlist(data.shortlist);

            // Display debug info
            if (document.getElementById('debugMode').checked && data.debug_info) {
                displayDebugInfo(data);
            }

            // Show results section
            resultsSection.classList.add('active');
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Create result item element
        function createResultItem(result, rank) {
            const div = document.createElement('div');
            div.className = 'result-item';
            div.onclick = () => copyCode(result.code);

            const scaleDollars = '$'.repeat(result.scale || 0);

            div.innerHTML = '<div class="result-header">' +
                '<div>' +
                '<span class="result-code">' + rank + '. ' + result.code + '</span>' +
                '<span class="result-term">— ' + result.term + '</span>' +
                '<span class="result-scale">' + scaleDollars + '</span>' +
                '</div>' +
                '</div>' +
                (result.keywords ? '<div class="result-keywords">(' + result.keywords + ')</div>' : '') +
                (result.explanation ? '<div class="result-explanation">' + result.explanation + '</div>' : '');

            return div;
        }

        // Display shortlist table
        function displayShortlist(shortlist) {
            shortlistData = shortlist || [];
            const tbody = document.getElementById('shortlistBody');
            tbody.innerHTML = '';

            shortlistData.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td>' + (index + 1) + '</td>' +
                    '<td style="font-weight: 600; color: var(--primary-color);">' + item['ED Short List code'] + '</td>' +
                    '<td>' + item['ED Short List Term'] + '</td>' +
                    '<td class="score-cell">' + item.Score.toFixed(3) + '</td>';
                tr.style.cursor = 'pointer';
                tr.onclick = () => copyCode(item['ED Short List code']);
                tbody.appendChild(tr);
            });
        }

        // Filter shortlist based on search
        function filterShortlist() {
            const searchTerm = document.getElementById('codeSearch').value.toLowerCase();
            const tbody = document.getElementById('shortlistBody');
            tbody.innerHTML = '';

            const filtered = searchTerm 
                ? shortlistData.filter(item => 
                    item['ED Short List code'].toLowerCase().includes(searchTerm) ||
                    item['ED Short List Term'].toLowerCase().includes(searchTerm)
                )
                : shortlistData;

            filtered.forEach((item, index) => {
                const originalIndex = shortlistData.indexOf(item);
                const tr = document.createElement('tr');
                tr.innerHTML = '<td>' + (originalIndex + 1) + '</td>' +
                    '<td style="font-weight: 600; color: var(--primary-color);">' + item['ED Short List code'] + '</td>' +
                    '<td>' + item['ED Short List Term'] + '</td>' +
                    '<td class="score-cell">' + item.Score.toFixed(3) + '</td>';
                tr.style.cursor = 'pointer';
                tr.onclick = () => copyCode(item['ED Short List code']);
                tbody.appendChild(tr);
            });
        }

        // Display debug information
        function displayDebugInfo(data) {
            document.getElementById('debugSection').style.display = 'block';
            
            document.getElementById('debugKeySymptoms').textContent = 
                data.key_symptoms || 'None identified';
            
            if (data.debug_info) {
                const debugTfidf = document.getElementById('debugTfidf');
                debugTfidf.innerHTML = 'Max score: ' + (data.debug_info.max_score ? data.debug_info.max_score.toFixed(4) : 'N/A') + '<br>' +
                    'Top 10 avg: ' + (data.debug_info.top_10_avg ? data.debug_info.top_10_avg.toFixed(4) : 'N/A') + '<br>' +
                    'Features: ' + (data.debug_info.tfidf_features || 'N/A');
            }

            // Show top 10 matches
            if (data.shortlist && data.shortlist.length > 0) {
                const top10 = data.shortlist.slice(0, 10).map((item, i) => 
                    (i + 1) + '. ' + item['ED Short List code'] + ' - ' + item['ED Short List Term'] + ' (' + item.Score.toFixed(3) + ')'
                ).join('<br>');
                document.getElementById('debugTopMatches').innerHTML = top10;
            }
        }

        // File handling
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type === 'text/plain') {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedFileContent = e.target.result;
                    document.getElementById('uploadedFileName').textContent = file.name;
                    document.getElementById('filePreview').value = uploadedFileContent;
                    document.getElementById('uploadedFile').style.display = 'block';
                };
                reader.readAsText(file);
            } else {
                showToast('Please select a .txt file', 'warning');
            }
        }

        // Drag and drop
        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'text/plain') {
                document.getElementById('fileInput').files = files;
                handleFileSelect({ target: { files: files } });
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('dragover');
        }

        // Batch processing
        function handleBatchSelect(event) {
            const files = Array.from(event.target.files).filter(f => f.type === 'text/plain');
            if (files.length === 0) {
                showToast('Please select .txt files', 'warning');
                return;
            }

            batchFiles = files;
            displayBatchFiles();
        }

        function handleBatchDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('dragover');
            
            const files = Array.from(event.dataTransfer.files).filter(f => f.type === 'text/plain');
            if (files.length > 0) {
                batchFiles = files;
                displayBatchFiles();
            }
        }

        function displayBatchFiles() {
            document.getElementById('batchFiles').style.display = 'block';
            document.getElementById('batchFileCount').textContent = batchFiles.length;
            
            const fileList = document.getElementById('batchFileList');
            fileList.innerHTML = '';
            
            batchFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = '<span class="file-name">' + file.name + '</span>' +
                    '<button class="btn-danger" onclick="removeBatchFile(' + index + ')">Remove</button>';
                fileList.appendChild(fileItem);
            });
        }

        function removeBatchFile(index) {
            batchFiles.splice(index, 1);
            if (batchFiles.length === 0) {
                document.getElementById('batchFiles').style.display = 'none';
            } else {
                displayBatchFiles();
            }
        }

        async function processBatch() {
            if (batchFiles.length === 0) return;

            document.getElementById('batchProgress').style.display = 'block';
            document.getElementById('batchResults').style.display = 'none';
            document.getElementById('totalFiles').textContent = batchFiles.length;

            const fileContents = [];
            
            // Read all files
            for (let i = 0; i < batchFiles.length; i++) {
                const file = batchFiles[i];
                document.getElementById('currentFile').textContent = i + 1;
                
                const content = await readFileAsBase64(file);
                fileContents.push({
                    filename: file.name,
                    content: content
                });

                // Update progress
                const progress = ((i + 1) / batchFiles.length) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
            }

            // Send batch request
            try {
                const response = await fetch(API_URL + '/batch-process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(fileContents)
                });

                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }

                // Download Excel file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ekoder_batch_' + new Date().toISOString().slice(0, 10) + '.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showToast('Batch processing complete! File downloaded.', 'success');
                
            } catch (error) {
                console.error('Batch processing error:', error);
                showToast('Error during batch processing: ' + error.message, 'error');
            } finally {
                document.getElementById('batchProgress').style.display = 'none';
            }
        }

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = btoa(reader.result);
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsBinaryString(file);
            });
        }

        // Utility functions
        function clearNote() {
            document.getElementById('noteInput').value = '';
            document.getElementById('results').classList.remove('active');
            currentResults = null;
        }

        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                showToast('Code ' + code + ' copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.style.display = 'flex';
            
            // Set background color based on type
            if (type === 'error') {
                toast.style.background = 'var(--danger-color)';
            } else if (type === 'warning') {
                toast.style.background = 'var(--warning-color)';
            } else if (type === 'success') {
                toast.style.background = 'var(--secondary-color)';
            } else {
                toast.style.background = 'var(--primary-color)';
            }
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        function showLoading() {
            // You can implement a global loading indicator if needed
        }

        function hideLoading() {
            // Hide global loading indicator
        }

        async function rebuildTFIDF() {
            try {
                const response = await fetch(API_URL + '/rebuild-tfidf', {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }

                const data = await response.json();
                showToast('TF-IDF rebuilt successfully! Features: ' + data.features, 'success');
                
            } catch (error) {
                console.error('Error rebuilding TF-IDF:', error);
                showToast('Error rebuilding TF-IDF: ' + error.message, 'error');
            }
        }

        function toggleDebugMode() {
            const debugMode = document.getElementById('debugMode').checked;
            
            // Show/hide debug sections based on current results
            if (currentResults) {
                if (debugMode) {
                    document.getElementById('gptRawSection').style.display = 'block';
                    if (currentResults.debug_info) {
                        displayDebugInfo(currentResults);
                    }
                } else {
                    document.getElementById('gptRawSection').style.display = 'none';
                    document.getElementById('debugSection').style.display = 'none';
                }
            }
        }
    </script>
</body>
</html>
